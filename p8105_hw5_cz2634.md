p8105 HW5
================
Chenxin Zhang
2020/11/16

## Problem 1

``` r
library(tidyverse)
```

    ## -- Attaching packages ------------------------- tidyverse 1.3.0 --

    ## v ggplot2 3.3.2     v purrr   0.3.4
    ## v tibble  3.0.3     v dplyr   1.0.2
    ## v tidyr   1.1.2     v stringr 1.4.0
    ## v readr   1.3.1     v forcats 0.5.0

    ## -- Conflicts ---------------------------- tidyverse_conflicts() --
    ## x dplyr::filter() masks stats::filter()
    ## x dplyr::lag()    masks stats::lag()

``` r
library(rvest)
```

    ## Loading required package: xml2

    ## 
    ## Attaching package: 'rvest'

    ## The following object is masked from 'package:purrr':
    ## 
    ##     pluck

    ## The following object is masked from 'package:readr':
    ## 
    ##     guess_encoding

``` r
library(ggplot2)
library(patchwork)
set.seed(1000)
knitr::opts_chunk$set(
  warning = FALSE,
  echo =TRUE,
  message = FALSE,
  fig.height = 8,
  fig.width = 8,
  fig.asp = .6,
  out.width = "90%"
)
theme_set(theme_minimal() + theme(legend.position = "bottom"))
options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)
scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```

## Problem 1

Read in the data.

``` r
#use mutate() to create a new variable
homicide_df = 
  read_csv("./data/homicide-data.csv") %>% 
  mutate(
    city_state = str_c(city, state, sep = "_"),
    resolved = case_when(
      disposition == "Closed without arrest" ~ "unsolved",
      disposition == "Open/No arrest"        ~ "unsolved",
      disposition == "Closed by arrest"      ~ "solved",
    )
  ) %>% 
  select(city_state, resolved) %>% 
  filter(city_state != "Tulsa_AL")
```

Let’s look at this a bit

``` r
aggregate_df = 
  homicide_df %>% 
  group_by(city_state) %>% 
  summarize(
    hom_total = n(),
    hom_unsolved = sum(resolved == "unsolved")
  )
```

Can I do a prop test for a single city?

``` r
# set x and n, the p is null=0.5
#broom::tidy()make the result a table, more clean way
prop.test(
  aggregate_df %>% filter(city_state == "Baltimore_MD") %>% pull(hom_unsolved), 
  aggregate_df %>% filter(city_state == "Baltimore_MD") %>% pull(hom_total)) %>% 
  broom::tidy()
```

    ## # A tibble: 1 x 8
    ##   estimate statistic  p.value parameter conf.low conf.high method    alternative
    ##      <dbl>     <dbl>    <dbl>     <int>    <dbl>     <dbl> <chr>     <chr>      
    ## 1    0.646      239. 6.46e-54         1    0.628     0.663 1-sample~ two.sided

Try to iterate ……..

``` r
#map2() gives you 2 elements, we get list 
#map broom::tidy across prop_test, we get a tibble for each city
results_df = 
  aggregate_df %>% 
  mutate(
    prop_tests = map2(.x = hom_unsolved, .y = hom_total, ~prop.test(x = .x, n = .y)),
    tidy_tests = map(.x = prop_tests, ~broom::tidy(.x))
  ) %>% 
  select(-prop_tests) %>% 
  unnest(tidy_tests) %>% 
  select(city_state, estimate, conf.low, conf.high)
```

``` r
results_df %>% 
  mutate(city_state = fct_reorder(city_state, estimate)) %>% 
  ggplot(aes(x = city_state, y = estimate)) +
  geom_point() + 
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high)) + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
```

<img src="p8105_hw5_cz2634_files/figure-gfm/unnamed-chunk-5-1.png" width="90%" />

``` r
#error = true means that the code will not stop when counter error in this code chunk when knit
city_prop_test = function(df) {
  
  n_unsovled = filter(city_state = df) %>% pull(hom_unsolved)
  n_total = filter(city_state = df) %>% pull(hom_total) 
  
  prop.test(n_unsovled, n_total) 
}

homicide_df = 
  read_csv("data/homicide-data.csv") %>% 
  mutate(
    city_state = str_c(city, state, sep = "_"),
    resolved = case_when(
      disposition == "Closed without arrest" ~ "unsolved",
      disposition == "Open/No arrest"        ~ "unsolved",
      disposition == "Closed by arrest"      ~ "solved",
    )
  ) %>% 
  select(city_state, resolved) %>% 
  filter(city_state != "Tulsa_AL") %>% 
  nest(data = resolved)
```

## Problem 2

**Import several data**

``` r
#list.files() will list all files in lda_data folder
#use tibble() to create a df contains all file names
#mutate string character in the column 'path'
#map read_csv() across each path 
path_df = 
  tibble(
    path = list.files("./data/lda_data"),
  ) %>% 
  mutate(
    path = str_c("./data/lda_data/", path),
    data = map(.x = path, ~read_csv(.x)))
```

**Tidy data**

``` r
#tidy data 
#str_replace specific string with nothing, equal to str_remove specific string in column
#separate column to two column by _
#case_when() and recode() to change string name
combined_df = path_df %>% 
  mutate(
    arm = str_replace(path, "./data/lda_data/", ""),
    arm = str_replace(arm, ".csv", "")
) %>% 
  separate(arm, into = c("arm", "subject_ID"), sep = "_") %>% 
  select(arm, subject_ID, data) %>% 
  mutate(
    arm = case_when(
    arm == "con" ~ "control",
    arm == "exp" ~ "experiment")
) %>% 
  unnest(data) %>% 
  pivot_longer(
    week_1:week_8,
    values_to = "data",
    names_to = "week"
) 
```

**Visualization**

``` r
combined_df %>% 
  unite(arm_id, arm, subject_ID, remove = FALSE) %>%
  ggplot(aes(x = week, y = data)) +
  geom_path(aes(color = arm, group = as.factor(arm_id)),alpha = 0.5) +
  labs(
    x = "Week",
    y = "Observation value",
    title = "The Observations group by subject over 8 weeks"
    )
```

<img src="p8105_hw5_cz2634_files/figure-gfm/unnamed-chunk-9-1.png" width="90%" />
\* As shown in the graph, both control group and experiment group has
similar observation value at week 1. As time going on, the observation
value of experiment group rise gradually over time, while control group
has no obvious difference from baseline.
